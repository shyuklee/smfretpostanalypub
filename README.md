# smfretpostanalypub

![smpostanalypub_intro _v2](https://github.com/shyuklee/smfretpostanalypub/assets/6265815/26ea85ae-08c2-4607-84ae-7a4730256198)


## Introduction
‘smfretpostanalypub’ imports single-molecule FRET (smFRET) trace data and performs various analysis and plotting. The current public release (v1.0) can import MATLAB MAT-files saved from [ebFRET](http://ebfret.github.io/). This software was developed using MATLAB_R2020a and was packaged into a standalone application for 64-bit Mac OSX (arch: ‘maci64’) and Windows (arch: ‘win64’) systems. A screenshot of the software is shown above. Each task is grouped inside a panel with a self-explanatory title. Two main graph windows display smFRET trace (lower window) and auxiliary trace (upper window) such as donor/acceptor signals. Different types of auxiliary trace can be selected by _‘Y Data Type’_ list box. As indicated by dotted red rectangular boxes in the screenshot, the tasks are largely classified as Data Import; Trace Display Control; Axes Control; Trace Modification/Selection; Plotting Tools; and Donor/Acceptor Channel Calibration & smPIFE Analysis. Each task will be explained in more detail below. 


## Install
A single executable file (smfretpostanalypub.app for Mac and smfretpostanalypub.exe for Windows) can be placed in any folder. The software recognizes the current working folder as the default location for file input/output. It is therefore recommended to put the executable file where smFRET trace data is located for convenience. **(Note: the current working folder path name should not contain a blank space for Mac OSX; otherwise, the default file IO folder is reset to the system root folder.)**

### Prerequisites: 
Version 9.8 (R2020a) of the MATLAB Runtime (MCR) should be installed.
If you have MATLAB installed, MCR may have been already installed too. To check it, enter  

    >> mcrinstaller
    
at the MATLAB prompt. Even if the version of the installed MCR is different than 9.8, the software might still work. Simply run smfretpostanalypub.app or smfretpostanalypub.exe to see if any MCR-related error is invoked. Even if you don’t have MATLAB, you can still run the software by downloading and installing MCR V9.8 from the following link on the MathWorks website: https://www.mathworks.com/products/compiler/mcr/index.html. More information about MCR can be found from the following link: https://www.mathworks.com/help/compiler/matlab-runtime.html.

## Description of software
### Prerequisites: 
Raw smFRET data are typically acquired as time-lapse images with a Total Internal Reflection Fluorescence (TIRF) microscope and an Electron Multiplying CCD (EMCCD) camera. The analysis of raw image data to identify bright fluorescence spots as single molecules and track their donor/acceptor fluorescence time traces can be performed with freely available software developed by several research groups (e.g., https://github.com/Ha-SingleMoleculeLab). In the next step, smFRET traces constructed from donor/acceptor time traces are then fitted with Hidden Markov Models (HMM) to characterize the dynamic transitions of smFRET using several publicly available software: [HaMMY](https://github.com/Ha-SingleMoleculeLab/HaMMy), [vbFRET](https://vbfret.sourceforge.net/), and [ebFRET](http://ebfret.github.io/). The software smfretpostanalypub herein performs additional analysis and plotting of HMM-fitted trace data. The major functions of the software are explained below. 

### Data Import: 
smfretpostanalypub currently supports only MATLAB MAT-file generated by ebFRET. _‘Import Data’_ button opens a window for users to select ebFRET files. Multiple files can be selected to analyse them all. 

### Trace Display Control: 
A specific trace to be displayed can be chosen by either changing the slider position or directly entering a trace ID in the text box. Display of the HMM-fitted trace can be toggled by _‘Ideal Trace’_ check box. The total number of imported traces is shown. The number of good traces after trace screening is also displayed in _‘N Good Trace’_ text box.

### Axes Control: 
The time unit (frame or second) and the display range of x- and y-axis can be changed here. The data type displayed in the auxiliary trace window can be selected among donor/acceptor (D/A), donor-acceptor signal sum (DA), smPIFE trace (PIFE), and calibrated smFRET trace (calFRET) in _‘Y Data Type’_ list box. 

### Trace Modification/Selection: 
The ideal traces fitted by ebFRET can be further modified by a set of analyses within _‘Ideal Trace Modification’_ panel.

**Fix False Transition:** For traces of high noise level, it is challenging to distinguish transition events of short-lived states from noise. If the user deems the HMM-fitting to be prone to identify noise as state-transitions, the transition events can be more conservatively assigned by running the analysis in this panel. The algorithm takes two adjacent smFRET trace segments that are identified as different states; computes their mean and standard deviation (μ_1,σ_1) and (μ_2,σ_2); computes R_12=|μ_1-μ_2 |/√(σ_1^2+σ_2^2 )  ; and compares R_12 to the value in ‘R12 Threshold’ text box. If R_12 is smaller than the threshold, the two segments are merged. _‘Del False Transitions’_ button initiates the process to generate modified ideal traces. _‘Choose Ideal Trace’_ panel allows switching between original and modified traces. 

**Auxiliary Fix:** It performs additional modification of ideal traces. During a transition between two FRET states, often times both the states partially reside within a single camera frame, producing an intermediate FRET value. HMM-fitting identifies it as a separate state sometime. _‘Fix Camera Blur’_ forces the intermediate FRET state to be absorbed into the nearest neighboring state (i.e., either the lower or the higher FRET state). Similarly, _‘Remove Short Dwell’_ allows the user to also remove any state with dwell time shorter than the value in _‘Short Dwell Cutoff’_ text box. In HMM-fitting, a segment of trace is forcefully assigned to one of a certain number of states (i.e., 3 states). HMM-fitted ideal traces usually well identify the segments of different FRET states, but sometime the actual FRET value of a segment appears different from the one assigned by HMM-fitting. _‘Segmental Average’_ maintains the segments of FRET states but changes the FRET values of HMM-fitted ideal states to the segment-wise average of raw FRET traces. 

**Segment Exclusion:** _‘Exclude Segment’_ allows the user to exclude segments of trace, whose FRET values are outside a certain range (defined by _‘FRET Upper Bnd’_ and _‘FRET Lower Bnd’_ text boxes), from further analysis. This is useful for removing the events of acceptor photo-bleaching and/or photo-blinking. 
Trace to be Excluded: The user can select certain traces for analysis based on several criteria in this panel. _‘Exclude Steady Low’_ check box removes the ideal trace if the number of states is equal or smaller than the value in _‘nState Threshold’_ text box and the FRET values are smaller than the threshold value in _‘FRET Threshold’_ text box. This is useful for eliminating traces that represent absence of biophysical activity (e.g., protein-unbound DNA). Donor/acceptor photo-bleaching and photo-blinking shorten the length of traces that is eligible for analysis. _‘Exclude Short Length’_ check box enables the user to exclude such traces with eligible length shorter than the threshold frame number in _‘Exclude Short Length’_ text box.

### Plotting Tools: 
Four types of analysis/plotting can be performed: FRET Histogram, Transition Density Plot (TDP), Dwell Time Analysis, and Pair Correlation Map. 

**FRET Histogram:** FRET histograms of raw and/or ideal traces can be selected with _‘Raw Tr’_ and _‘Ideal Tr’_ check boxes. _‘Fit Multi Gaussian’_ button fits FRET histograms with 1D Gaussian mixture models. The user can provide the number of Gaussian populations and the initial guess of FRET values dividing the populations to _‘N Mix’_ and _‘Init Div Lines’_ text boxes, respectively. The histogram bin size can be determined either automatically (_‘Auto’_ button) or manually (_‘nBin’_ or _‘Bin size’_ button). The value in the text box represents either number of bins or bin size in the manual mode, depending on whether _‘nBin’_ or _‘Bin size’_ button is selected.

**Tran Den Plot (TDP):** _‘Plot TDP’_ button generates TDP **(Note: _‘Exclude Segment’_ button should be unchecked when plotting TDP; otherwise, the plot will appear blank)**. The major populations appearing in TDP can be localized with 2D Gaussian mixture models-based clustering algorithms if _‘Find Cluster’_ button is checked. The number of clusters should be provided by the user in _‘N Clus’_ text box. 

**Dwell Time:**  Various methods to estimate kinetic rates of transitions among FRET states have been published. These methods become quite sophisticated when the number of states gets large and they are typically integrated in HMM-fitting. Because smfretpostanalypub modifies HMM-fitted ideal traces through postprocessing in a way the HMM-defined states are invalidated, a rather robust way to estimate the kinetic rates through dwell time analysis (currently works only for 2-state models) is implemented here. The intervals of states in ideal traces are reassigned to either high or low FRET states based on the user-provided threshold value in _‘High State Threshold’_ text box, which can be reasonably determined from the FRET histogram plot. The dwell time data in the beginning and the end of a trace can be excluded from dwell time analysis with checking _‘Exclude Start/End Dwell Time’_ text box. _‘Plot Dwell Time’_ button plots dwell time histograms of the low and the high FRET states. The histogram plot range and bin size are automatically determined if _‘Auto’_ button is checked but otherwise they are manually provided by the values in _‘Plot Lim (S)’_ and _‘Bin Size (Fr)’_ text boxes. A dwell time histogram follows a single exponential decay function in the case of first-order kinetics, but often times a weighted sum of two exponential decay functions better fit smFRET data when two degenerate states with almost identical FRET values are present. The fitting of dwell time histogram with single or double exponential functions can be performed with _‘Fitting’_ button and _‘exp1 vs exp2’_ fit-model choice list box. Dwell time longer than the value in _‘Fit Lim (S)’_ text box is considered as outliers and is discarded. Events faster than camera frame rate are beyond the detection limit of a microscope. The degraded detection efficiency for short dwell time relative to camera frame rate makes dwell time histograms deviate from exponential distribution functions at short dwell time range; hence, dropping short dwell time data improves the precision of exponential function fitting, which is implemented by _‘Drop Short Dwell (Frame) leq’_ button and text box.

**Pair Correlation Map:**  This panel is for plotting pairwise 2D heat map (i.e., smoothed 2D histogram) of any choice of two quantities. **(Note: ‘Exclude Trace’ button should be unchecked when plotting pairwise 2D heat map; otherwise, errors will be invoked)**. _‘X Axis’_ and _‘Y Axis’_ list boxes display the supported quantities to be selected by the user, where D, A, and DA stand for donor, acceptor, and donor-acceptor sum, respectively. _‘nBin’_ text boxes specify number of bins in X- and Y-axis. The range of plot can be automatically determined based on the outlier quantile value in _‘Outlier Quantile’_ text box or the user can provide them in the form of ‘[lower bound, upper bound]’ inside the text boxes located below _‘Auto XLim’_ and _‘Auto YLim’_ buttons. The major populations appearing in 2D heat map can be localized with 2D Gaussian mixture models-based clustering algorithms if _‘Find Cluster’_ button is checked. The number of clusters should be provided by the user in _‘N Cluster’_ text box.

### Donor/Acceptor Channel Calibration & smPIFE Analysis: 
This panel allows the user to calibrate donor and acceptor fluorescence detection channels in order to generate correlative smPIFE-smFRET traces when Cy3 is used as donor fluorophore.
